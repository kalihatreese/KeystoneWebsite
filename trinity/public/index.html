<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keystone Â· Trinity Â· Veritas</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/OutputPass.js"></script>

    <style>
        body { margin:0; overflow:hidden; background-color:#000005; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color:#E0E0E0; }
        canvas { display:block; }
        #ui-overlay { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; display:flex; flex-direction:column; justify-content:space-between; padding:20px; box-sizing:border-box; z-index:10; }
        #veritas-voice-box { align-self:flex-start; background:rgba(0,10,30,0.7); border:1px solid #00FFFF; padding:10px 15px; border-radius:5px; max-width:300px; font-size:1.1em; text-shadow:0 0 5px #00FFFF; opacity:0; transition:opacity 1s; pointer-events:none; }
        .portal-label { position:absolute; padding:5px 10px; background:rgba(0,0,0,0.6); border:1px solid #0088FF; color:#00FFFF; font-size:0.9em; cursor:pointer; pointer-events:auto; transition:background 0.3s,color 0.3s; transform:translate(-50%,-50%); }
        .portal-label:hover { background:rgba(0,150,255,0.8); color:#FFFFFF; text-shadow:0 0 8px #FFFFFF; }
    </style>
</head>
<body>
    <div id="ui-overlay">
        <div id="veritas-voice-box">
            "Welcome, Reese. This is your Trinity. Every particle, code, and word here is your history, your logic, your path."
        </div>
    </div>
    <script>
        // --- âš™ï¸ Global Constants & Utilities ---
        const PRIMARY_COLOR = 0x00FFFF; 
        const SECONDARY_COLOR = 0xAAAAAA; 
        const EMISSIVE_INTENSITY = 3.0; 

        // --- ðŸŽ§ Web Audio API / AudioEngine ---
        const AudioEngine = (function() {
            let audioContext, listener, panner;
            function init() { window.addEventListener('click', startAudioContext, {once:true}); }
            function startAudioContext() {
                if(audioContext) return;
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    listener = audioContext.listener;
                    panner = audioContext.createPanner();
                    panner.pannerModel='HRTF'; panner.distanceModel='inverse'; panner.refDistance=1; panner.maxDistance=1000; panner.coneOuterGain=0;
                    panner.connect(audioContext.destination);
                    playVeritasPlaceholder();
                } catch(e){ console.error(e); }
            }
            function playVeritasPlaceholder() {
                if(!audioContext) return;
                const osc=audioContext.createOscillator(); const gain=audioContext.createGain();
                osc.type='sawtooth'; osc.frequency.setValueAtTime(80,audioContext.currentTime);
                gain.gain.setValueAtTime(0.02,audioContext.currentTime);
                osc.connect(gain).connect(panner); osc.start(); osc.stop(audioContext.currentTime+4);
                const box=document.getElementById('veritas-voice-box'); box.style.opacity='1';
                setTimeout(()=>{box.style.opacity='0';},3500);
            }
            function updateListenerPosition(x,y,z){if(listener&&audioContext.state==='running'){listener.positionX.setValueAtTime(x,audioContext.currentTime);listener.positionY.setValueAtTime(y,audioContext.currentTime);listener.positionZ.setValueAtTime(z,audioContext.currentTime);}}
            function updateVeritasPosition(x,y,z){if(panner){panner.positionX.setValueAtTime(x,audioContext.currentTime);panner.positionY.setValueAtTime(y,audioContext.currentTime);panner.positionZ.setValueAtTime(z,audioContext.currentTime);}}
            return { init, updateListenerPosition, updateVeritasPosition };
        })();

        // --- âœ¨ Particle Engine Module ---
        const ParticleEngine = (function() {
            let particles; const particleCount=2000; const particleGeometry=new THREE.BufferGeometry();
            const positions=new Float32Array(particleCount*3);
            for(let i=0;i<particleCount*3;i++){positions[i]=(Math.random()-0.5)*50;}
            particleGeometry.setAttribute('position',new THREE.BufferAttribute(positions,3));
            const particleMaterial=new THREE.PointsMaterial({color:PRIMARY_COLOR,size:0.05,blending:THREE.AdditiveBlending,transparent:true,sizeAttenuation:true,map:createParticleTexture()});
            function createParticleTexture(){const c=document.createElement('canvas');c.width=16;c.height=16;const ctx=c.getContext('2d');const grad=ctx.createRadialGradient(8,8,0,8,8,8);grad.addColorStop(0,'rgba(0,255,255,1)');grad.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=grad;ctx.fillRect(0,0,16,16);return new THREE.CanvasTexture(c);}
            function init(scene){particles=new THREE.Points(particleGeometry,particleMaterial);scene.add(particles);}
            function animate(time){if(!particles)return;const pos=particles.geometry.attributes.position.array;const speed=0.005;for(let i=0;i<particleCount;i++){pos[i*3+0]+=Math.sin(time*0.0005+pos[i*3+1])*speed;pos[i*3+1]+=Math.cos(time*0.0004+pos[i*3+2])*speed;pos[i*3+2]+=speed*2;if(pos[i*3+2]>10){pos[i*3+2]=-40;}}particles.geometry.attributes.position.needsUpdate=true;}
            return { init, animate };
        })();

        // --- ðŸ›ï¸ Room Definitions ---
        const RoomDefinitions = {
            'Trinity':{
                cameraPosition:{x:0,y:1.5,z:5},
                color:0x000011,
                veritasPosition:{x:0,y:2,z:0},
                fragments:[
                    {position:{x:2.5,y:2,z:-2},text:"Reese: Origin of Keystone Logic",scale:0.6},
                    {position:{x:-3,y:0.8,z:1},text:"Code Snippets & AI Thoughts",scale:0.5},
                    {position:{x:0,y:-0.5,z:-4},text:"Historic Conversations Highlights",scale:0.7},
                ],
                portals:[
                    {name:'Cyber Cop',position:{x:5,y:1,z:-5}},
                    {name:'Veritas',position:{x:-5,y:1,z:-5}},
                ]
            },
            'Cyber Cop':{
                cameraPosition:{x:10,y:1.5,z:0},
                color:0x111100,
                veritasPosition:{x:10,y:2,z:5},
                fragments:[],
                portals:[{name:'Trinity',position:{x:5,y:1,z:0}}]
            },
            'Veritas':{
                cameraPosition:{x:0,y:5,z:-10},
                color:0x110011,
                veritasPosition:{x:0,y:5,z:-5},
                fragments:[],
                portals:[{name:'Trinity',position:{x:0,y:0,z:-5}}]
            }
        };

        // --- ðŸŒ Scene Manager ---
        const SceneManager=(function(){let scene,camera,renderer,composer,currentRoomName,activeFragments=[],portalMeshes={},container=document.body,raycaster=new THREE.Raycaster(),mouse=new THREE.Vector2();
        function init(){scene=new THREE.Scene();camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);renderer=new THREE.WebGLRenderer({antialias:true,alpha:false});renderer.setSize(window.innerWidth,window.innerHeight);renderer.setPixelRatio(window.devicePixelRatio);renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=0.5;container.appendChild(renderer.domElement);setupPostProcessing();
        scene.add(new THREE.AmbientLight(0x111122));const pl=new THREE.PointLight(PRIMARY_COLOR,5,50,2);pl.position.set(0,5,0);scene.add(pl);ParticleEngine.init(scene);loadRoom('Trinity',true);window.addEventListener('resize',onWindowResize);document.addEventListener('click',handleClicks);animate();}
        function setupPostProcessing(){composer=new THREE.EffectComposer(renderer);composer.setPixelRatio(window.devicePixelRatio);composer.setSize(window.innerWidth,window.innerHeight);composer.addPass(new THREE.RenderPass(scene,camera));composer.addPass(new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),0.4,0.2,0.05));composer.addPass(new THREE.OutputPass());}
        function clearRoomObjects(){scene.children.filter(o=>o.userData.isRoomObject||o.userData.isFragment||o.userData.isPortal).forEach(o=>scene.remove(o));
        activeFragments.forEach(f=>{if(f.userData.label)f.userData.label.remove();f.geometry.dispose();f.material.dispose();});activeFragments=[];portalMeshes={};scene.children.filter(g=>g.name==='GroundPlane').forEach(g=>{scene.remove(g);g.geometry.dispose();g.material.dispose();});}
        function loadRoom(name,isInitial=false){if(currentRoomName===name&&!isInitial)return;currentRoomName=name;const room=RoomDefinitions[name];clearRoomObjects();
        const ground=new THREE.Mesh(new THREE.PlaneGeometry(30,30),new THREE.MeshStandardMaterial({color:SECONDARY_COLOR,metalness:0.9,roughness:0.1,side:THREE.DoubleSide}));
        ground.rotation.x=-Math.PI/2;ground.position.y=-0.5;ground.name='GroundPlane';scene.add(ground);
        room.fragments.forEach(f=>createFragment(f));room.portals.forEach(p=>createPortal(p.name,p.position));transitionTo(room.cameraPosition,room.veritasPosition,name);}
        function createFragment(d){const m=new THREE.MeshStandardMaterial({color:PRIMARY_COLOR,emissive:PRIMARY_COLOR,emissiveIntensity:EMISSIVE_INTENSITY,metalness:0.8,roughness:0.2,transparent:true,opacity:0.8});const f=new THREE.Mesh(new THREE.TorusKnotGeometry(0.5,0.1,100,16),m);f.scale.setScalar(d.scale||1);f.position.set(d.position.x,d.position.y,d.position.z);
        f.userData={isFragment:true,initialY:d.position.y,rotationSpeed:Math.random()*0.01+0.005,narrative:d.text};const l=document.createElement('div');l.className='portal-label';l.textContent=d.text;document.getElementById('ui-overlay').appendChild(l);f.userData.label=l;l.style.pointerEvents='none';scene.add(f);activeFragments.push(f);}
        function createPortal(name,pos){const g=new THREE.Mesh(new THREE.BoxGeometry(2,2,0.2),new THREE.MeshStandardMaterial({color:0x00FF88,emissive:0x00FF88,emissiveIntensity:EMISSIVE_INTENSITY/2,metalness:0.5,roughness:0.5,transparent:true,opacity:0.6}));g.position.set(pos.x,pos.y,pos.z);g.userData={isPortal:true,targetRoom:name};scene.add(g);portalMeshes[name]=g;const l=document.createElement('div');l.className='portal-label';l.textContent=`[ACCESS: ${name}]`;l.onclick=()=>loadRoom(name);document.getElementById('ui-overlay').appendChild(l);g.userData.label=l;}
        function transitionTo(c,v,roomName){gsap.to(camera.position,{duration:3.5,x:c.x,y:c.y,z:c.z,ease:"power3.inOut",onStart:()=>{renderer.domElement.style.opacity=0.5;document.body.style.pointerEvents='none';},onComplete:()=>{renderer.domElement.style.opacity=1;document.body.style.pointerEvents='auto';const vb=document.getElementById('veritas-voice-box');vb.innerHTML=`Veritas: Entering **${roomName}** chamber. Analyzing data streams...`;vb.style.opacity='1';setTimeout(()=>{vb.style.opacity='0';},4000);}});AudioEngine.updateListenerPosition(c.x,c.y,c.z);AudioEngine.updateVeritasPosition(v.x,v.y,v.z);}
        function handleClicks(e){e.preventDefault();mouse.x=(e.clientX/window.innerWidth)*2-1;mouse.y=-(e.clientY/window.innerHeight)*2+1;raycaster.setFromCamera(mouse,camera);const ints=raycaster.intersectObjects(Object.values(portalMeshes),false);if(ints.length>0){const t=ints[0].object;if(t.userData.isPortal){loadRoom(t.userData.targetRoom);}}}
        function updateHTMLLabels(){const v=new THREE.Vector3(),r=container.getBoundingClientRect();[...activeFragments,...Object.values(portalMeshes)].forEach(o=>{if(o.userData.label){o.updateWorldMatrix(true,false);o.getWorldPosition(v);v.project(camera);const x=(v.x*0.5+0.5)*r.width;const y=(v.y*-0.5+0.5)*r.height;o.userData.label.style.left=`${x}px`;o.userData.label.style.top=`${y}px`;o.userData.label.style.display=v.z>1?'none':'block';}});}
        function animate(t){requestAnimationFrame(animate);activeFragments.forEach(f=>{f.rotation.x+=f.userData.rotationSpeed/2;f.rotation.y+=f.userData.rotationSpeed;f.position.y=f.userData.initialY+Math.sin(t*0.001+f.position.x)*0.2;});Object.values(portalMeshes).forEach(p=>{p.rotation.x+=0.005;p.rotation.y+=0.01;const s=1+Math.sin(t*0.002)*0.05;p.scale.set(s,s,s);});ParticleEngine.animate(t);updateHTMLLabels();composer.render();}
        function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);composer.setSize(window.innerWidth,window.innerHeight);}
        return { init };
        })();

        document.addEventListener('DOMContentLoaded',()=>{SceneManager.init();AudioEngine.init();});
    </script>
</body>
</html>
